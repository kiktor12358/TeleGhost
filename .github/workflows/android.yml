name: Build Android AAR

on:
  push:
    tags:
      - 'v*'
      - '[0-9]*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

permissions:
  contents: write

env:
  GO_VERSION: '1.24.0'
  NDK_VERSION: '26.1.10909125'
  ANDROID_API: '24'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Go Ğ¿Ğ°ĞºĞµÑ‚ mobile Ğ² teleghost.aar Ñ‡ĞµÑ€ĞµĞ· gomobile bind
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-aar:
    name: Build Go â†’ AAR (gomobile)
    runs-on: ubuntu-latest
    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup Go â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # â”€â”€ 3. Setup Java (Ğ´Ğ»Ñ Android SDK/gomobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # â”€â”€ 4. Setup Android SDK + NDK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          echo "Installing NDK ${{ env.NDK_VERSION }}..."
          sdkmanager --install "ndk;${{ env.NDK_VERSION }}"
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ANDROID_NDK_HOME
          export ANDROID_NDK_HOME="$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          
          echo "NDK installed at: $ANDROID_NDK_HOME"
          ls -la "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/" | head -20

      # â”€â”€ 5. Install gomobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ GOPATH/bin Ğ² PATH
          export PATH="$PATH:$(go env GOPATH)/bin"
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          
          # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ gomobile
          gomobile init

      # â”€â”€ 6. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ´Ğ»Ñ CGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            zlib1g-dev

      # â”€â”€ 7. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° NDK ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ CGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ: gomobile ÑĞ°Ğ¼ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ CC/CXX, Ğ½Ğ¾ Ğ¼Ñ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹
      # ÑƒĞ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ Ñ‡Ñ‚Ğ¾ CGO_ENABLED=1 Ğ¸ NDK Ñ‚ÑƒĞ»Ñ‡ĞµĞ¹Ğ½ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.
      #
      - name: Configure NDK environment for CGO
        run: |
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          
          echo "â”€â”€â”€â”€ NDK Toolchain contents â”€â”€â”€â”€"
          ls "$NDK_TOOLCHAIN/bin/" | grep -E "clang$|clang\+\+$" | head -10
          
          # Ğ”Ğ»Ñ arm64 (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°)
          echo "CC_arm64=${NDK_TOOLCHAIN}/bin/aarch64-linux-android${ANDROID_API}-clang" >> $GITHUB_ENV
          echo "CXX_arm64=${NDK_TOOLCHAIN}/bin/aarch64-linux-android${ANDROID_API}-clang++" >> $GITHUB_ENV
          
          # Ğ”Ğ»Ñ arm (armv7)
          echo "CC_arm=${NDK_TOOLCHAIN}/bin/armv7a-linux-androideabi${ANDROID_API}-clang" >> $GITHUB_ENV
          echo "CXX_arm=${NDK_TOOLCHAIN}/bin/armv7a-linux-androideabi${ANDROID_API}-clang++" >> $GITHUB_ENV
          
          # Ğ”Ğ»Ñ x86_64
          echo "CC_x86_64=${NDK_TOOLCHAIN}/bin/x86_64-linux-android${ANDROID_API}-clang" >> $GITHUB_ENV
          echo "CXX_x86_64=${NDK_TOOLCHAIN}/bin/x86_64-linux-android${ANDROID_API}-clang++" >> $GITHUB_ENV
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²
          echo "â”€â”€â”€â”€ Compiler verification â”€â”€â”€â”€"
          "${NDK_TOOLCHAIN}/bin/aarch64-linux-android${ANDROID_API}-clang" --version || true
          "${NDK_TOOLCHAIN}/bin/armv7a-linux-androideabi${ANDROID_API}-clang" --version || true

      # â”€â”€ 8. Go dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download Go dependencies
        run: |
          go mod download
          go mod verify

      # â”€â”€ 9. Setup Node.js & Build Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          echo "â”€â”€â”€â”€ Frontend dist â”€â”€â”€â”€"
          ls -la dist/

      - name: Copy frontend to mobile package
        run: |
          rm -rf mobile/dist
          cp -r frontend/dist mobile/dist
          ls -la mobile/dist

      # â”€â”€ 10. Install Boost (Headers Only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download Boost Headers
        run: |
          BOOST_VER="1.84.0"
          BOOST_NAME="boost_1_84_0"
      # â”€â”€ 10. Install Boost (Headers Only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download Boost Prebuilts
        run: |
          echo "Cloning Boost for Android (PurpleI2P)..."
          # Clone specific branch (e.g. boost-1_78_0 as latest prebuilt available)
          git clone --depth 1 -b boost-1_78_0 https://github.com/PurpleI2P/Boost-for-Android-Prebuilt.git boost_prebuilt
          
          
          
          echo "Scanning for Boost root..."
          ls -F boost_prebuilt/
          
          # Find version directory (e.g. boost-1_78_0 or boost_1_78_0)
          # We prefer the subdirectory if it exists
          BOOST_SUBDIR=$(find boost_prebuilt -maxdepth 1 -type d -name "boost*" | grep -v "^boost_prebuilt$" | head -n 1)
          
          if [ -n "$BOOST_SUBDIR" ]; then
             echo "Found Boost Version Subdir: $BOOST_SUBDIR"
             echo "BOOST_ROOT=$PWD/$BOOST_SUBDIR" >> $GITHUB_ENV
          elif [ -d "boost_prebuilt/boost" ] || [ -d "boost_prebuilt/include/boost" ]; then
             echo "Found Boost content in root."
             echo "BOOST_ROOT=$PWD/boost_prebuilt" >> $GITHUB_ENV
          else
             echo "Error: Could not find any boost directory usage pattern 'boost*' inside boost_prebuilt"
             ls -R boost_prebuilt
             exit 1
          fi

      - name: Download OpenSSL Prebuilts
        run: |
          echo "Cloning OpenSSL for Android (PurpleI2P)..."
          git clone --depth 1 https://github.com/PurpleI2P/OpenSSL-for-Android-Prebuilt.git openssl_prebuilt
          
          # PurpleI2P structure: openssl-1.1.1/{arch}/include
          echo "OPENSSL_ROOT=$PWD/openssl_prebuilt/openssl-1.1.1/arm64-v8a" >> $GITHUB_ENV
          
      - name: Verify OpenSSL Structure
        run: |
          ls -R openssl_prebuilt | head -20
          echo "--- Checking specific path ---"
          ls -F openssl_prebuilt/openssl-1.1.1/ || true

      - name: Compile i2pd (Android)
        run: |
          chmod +x scripts/build_i2pd_android.sh
          
          # Find OpenSSL base
          OPENSSL_DIR=$(find openssl_prebuilt -maxdepth 1 -type d -name "openssl-1.1*" | head -n 1)
          if [ -z "$OPENSSL_DIR" ]; then OPENSSL_DIR="openssl_prebuilt/openssl-1.1.1"; fi
          OPENSSL_ROOT="$PWD/$OPENSSL_DIR"
          
          # Source
          I2PD_SRC="$PWD/internal/network/i2pd/i2pd"
          
          echo "Building i2pd with:"
          echo "  NDK: $ANDROID_NDK_HOME"
          echo "  OpenSSL: $OPENSSL_ROOT"
          echo "  Boost: $BOOST_ROOT"
          
          # Run build script
          ./scripts/build_i2pd_android.sh "$ANDROID_NDK_HOME" "$OPENSSL_ROOT" "$BOOST_ROOT" "$I2PD_SRC"
          
          echo "Verifying compiled libs..."
          ls -R internal/network/i2pd/lib
          
          # Copy Boost Libs to internal/network/i2pd/lib/{arch}
          echo "Copying Boost libraries..."
          
          # Function to find and copy boost libs
          cp_boost() {
             ARCH_SRC=$1
             ARCH_DST=$2
             # Check potential boost lib paths
             # PurpleI2P boost structure usually: boost-1.x/lib/arch/libboost_*.a OR boost-1.x/arch/lib
             
             SRC_DIR=""
             if [ -d "$BOOST_ROOT/lib/$ARCH_SRC" ]; then SRC_DIR="$BOOST_ROOT/lib/$ARCH_SRC"; fi
             if [ -d "$BOOST_ROOT/$ARCH_SRC/lib" ]; then SRC_DIR="$BOOST_ROOT/$ARCH_SRC/lib"; fi
             
             if [ -n "$SRC_DIR" ]; then
                echo "Found Boost libs at $SRC_DIR. Copying..."
                cp "$SRC_DIR"/libboost_program_options.a "internal/network/i2pd/lib/$ARCH_DST/" || echo "Warn: libboost_program_options.a not found"
                # Add filesystem/system if needed, but modern boost might be header-only for those or not needed
             else
                 echo "Error: Boost libs for $ARCH_SRC not found structure!"
                 ls -R "$BOOST_ROOT" | head -n 20
             fi
          }
          
          cp_boost "arm64-v8a" "arm64-v8a"
          cp_boost "armeabi-v7a" "armeabi-v7a"
          cp_boost "x86_64" "x86_64"
          cp_boost "x86" "x86"

      # â”€â”€ 11. BUILD: gomobile bind â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build AAR with CGO
        run: |
          export PATH="$PATH:$(go env GOPATH)/bin"
          export CGO_ENABLED=1
          export ANDROID_NDK_HOME="${{ env.ANDROID_NDK_HOME }}"
          
          # 1. Find Boost include dir (EXACT PATH for C++ headers)
          BOOST_H_PATH=$(find boost_prebuilt -name version.hpp | grep "boost/version.hpp" | head -n 1)
          if [ -z "$BOOST_H_PATH" ]; then
            echo "Error: boost/version.hpp not found!"
            find boost_prebuilt -maxdepth 3
            exit 1
          fi
          BOOST_INCLUDE_DIR=$(dirname $(dirname "$BOOST_H_PATH"))
          echo "Found Boost include dir: $BOOST_INCLUDE_DIR"

          # 2. Find OpenSSL include dir
          DSA_H=$(find openssl_prebuilt -name dsa.h | head -n 1)
          if [ -z "$DSA_H" ]; then
            echo "Error: openssl/dsa.h not found!"
            exit 1
          fi
          OPENSSL_INCLUDE_DIR=$(dirname $(dirname "$DSA_H"))
          echo "Found OpenSSL include dir: $OPENSSL_INCLUDE_DIR"
          
          # 3. Set CGO flags with ALL necessary include paths
          # We need: i2pd headers AND dependency headers
          I2P_INC="-I$GITHUB_WORKSPACE/internal/network/i2pd/i2pd/libi2pd -I$GITHUB_WORKSPACE/internal/network/i2pd/i2pd/libi2pd_client -I$GITHUB_WORKSPACE/internal/network/i2pd/i2pd/i18n -I$GITHUB_WORKSPACE/internal/network/i2pd/i2pd"
          DEP_INC="-I$GITHUB_WORKSPACE/$BOOST_INCLUDE_DIR -I$GITHUB_WORKSPACE/$OPENSSL_INCLUDE_DIR"
          
          # Fix for Boost + Clang compatibility:
          # -Wno-enum-constexpr-conversion: Fixes -1 outside range error in Boost MPL
          # -Wno-deprecated-builtins: Silences warnings about deprecated triviality checks
          # -D_LIBCPP_ENABLE_CXX17_REMOVED_UNARY_FUNCTION: Consistency with i2pd build
          EXTRA_FLAGS="-Wno-enum-constexpr-conversion -Wno-deprecated-builtins -D_LIBCPP_ENABLE_CXX17_REMOVED_UNARY_FUNCTION"
          
          export CGO_CXXFLAGS="$I2P_INC $DEP_INC $EXTRA_FLAGS"
          export CGO_CFLAGS="$DEP_INC"
          
          echo "CGO_CXXFLAGS: $CGO_CXXFLAGS"
          
          echo "â”€â”€â”€â”€ Library structure (Verification) â”€â”€â”€â”€"
          # Verify that libs were copied by our script
          ls -R internal/network/i2pd/lib
          
          echo "  CGO_ENABLED=$CGO_ENABLED"
          echo "  ANDROID_NDK_HOME=$ANDROID_NDK_HOME"
          echo "  Target: android (API ${{ env.ANDROID_API }})"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° .aar
          CGO_ENABLED=1 gomobile bind \
            -v \
            -tags cgo_i2pd \
            -target=android \
            -androidapi ${{ env.ANDROID_API }} \
            -o teleghost.aar \
            ./mobile
          
          echo "â”€â”€â”€â”€ Build output â”€â”€â”€â”€"
          ls -lh teleghost.aar
          file teleghost.aar

      # â”€â”€ 10. Upload AAR artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleghost-aar
          path: teleghost.aar
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Android APK (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Gradle Ğ¿Ñ€Ğ¾ĞµĞºÑ‚)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-apk:
    name: Build Android APK
    needs: build-aar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ .aar Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ job-Ğ°
      - name: Download AAR artifact
        uses: actions/download-artifact@v4
        with:
          name: teleghost-aar
          path: android/app/libs/

      - name: Verify AAR
        run: |
          echo "â”€â”€â”€â”€ Verifying AAR â”€â”€â”€â”€"
          ls -lh android/app/libs/
          file android/app/libs/teleghost.aar

      # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ (Svelte â†’ dist)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          echo "â”€â”€â”€â”€ Frontend dist â”€â”€â”€â”€"
          ls -la dist/

      # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ dist Ğ² assets Android Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
      # (Ñ…Ğ¾Ñ‚Ñ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Go Ñ€Ğ°Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ ÑĞ°Ğ¼, Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²)
      - name: Copy frontend to Android assets
        run: |
          mkdir -p android/app/src/main/assets
          cp -r frontend/dist/* android/app/src/main/assets/
          echo "â”€â”€â”€â”€ Android assets â”€â”€â”€â”€"
          ls -la android/app/src/main/assets/

      # Gradle build
      - name: Build APK
        run: |
          cd android
          chmod +x gradlew 2>/dev/null || true
          ./gradlew assembleDebug --stacktrace || {
            echo "â”€â”€â”€â”€ Gradle wrapper not found, using system gradle â”€â”€â”€â”€"
            gradle assembleDebug --stacktrace
          }

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleghost-android-debug
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Release (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ push Ñ‚ĞµĞ³Ğ° v*)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release-android:
    name: Release Android
    needs: [build-aar, build-apk]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download AAR
        uses: actions/download-artifact@v4
        with:
          name: teleghost-aar

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: teleghost-android-debug

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            teleghost.aar
            *.apk
          draft: false
          prerelease: true
          body: |
            ## Android Build ğŸ¤–
            
            ### ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹:
            - `teleghost.aar` â€” Go Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° Ğ´Ğ»Ñ Android (gomobile bind + CGO)
            - `*.apk` â€” Debug APK Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            
            ### Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
            - Android 5.0+ (API 21)
            - ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹: arm64-v8a, armeabi-v7a, x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
