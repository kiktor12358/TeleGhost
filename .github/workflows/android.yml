name: Build Android AAR

on:
  push:
    branches: [ main, android-* ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

permissions:
  contents: write

env:
  GO_VERSION: '1.24.0'
  NDK_VERSION: '26.1.10909125'
  ANDROID_API: '21'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Go Ğ¿Ğ°ĞºĞµÑ‚ mobile Ğ² teleghost.aar Ñ‡ĞµÑ€ĞµĞ· gomobile bind
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-aar:
    name: Build Go â†’ AAR (gomobile)
    runs-on: ubuntu-latest
    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup Go â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # â”€â”€ 3. Setup Java (Ğ´Ğ»Ñ Android SDK/gomobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # â”€â”€ 4. Setup Android SDK + NDK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          echo "Installing NDK ${{ env.NDK_VERSION }}..."
          sdkmanager --install "ndk;${{ env.NDK_VERSION }}"
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ANDROID_NDK_HOME
          export ANDROID_NDK_HOME="$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          
          echo "NDK installed at: $ANDROID_NDK_HOME"
          ls -la "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/" | head -20

      # â”€â”€ 5. Install gomobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ GOPATH/bin Ğ² PATH
          export PATH="$PATH:$(go env GOPATH)/bin"
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          
          # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ gomobile
          gomobile init

      # â”€â”€ 6. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ´Ğ»Ñ CGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            zlib1g-dev

      # â”€â”€ 7. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° NDK ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ CGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ: gomobile ÑĞ°Ğ¼ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ CC/CXX, Ğ½Ğ¾ Ğ¼Ñ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹
      # ÑƒĞ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ Ñ‡Ñ‚Ğ¾ CGO_ENABLED=1 Ğ¸ NDK Ñ‚ÑƒĞ»Ñ‡ĞµĞ¹Ğ½ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.
      #
      - name: Configure NDK environment for CGO
        run: |
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          
          echo "â”€â”€â”€â”€ NDK Toolchain contents â”€â”€â”€â”€"
          ls "$NDK_TOOLCHAIN/bin/" | grep -E "clang$|clang\+\+$" | head -10
          
          # Ğ”Ğ»Ñ arm64 (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°)
          echo "CC_arm64=${NDK_TOOLCHAIN}/bin/aarch64-linux-android${ANDROID_API}-clang" >> $GITHUB_ENV
          echo "CXX_arm64=${NDK_TOOLCHAIN}/bin/aarch64-linux-android${ANDROID_API}-clang++" >> $GITHUB_ENV
          
          # Ğ”Ğ»Ñ arm (armv7)
          echo "CC_arm=${NDK_TOOLCHAIN}/bin/armv7a-linux-androideabi${ANDROID_API}-clang" >> $GITHUB_ENV
          echo "CXX_arm=${NDK_TOOLCHAIN}/bin/armv7a-linux-androideabi${ANDROID_API}-clang++" >> $GITHUB_ENV
          
          # Ğ”Ğ»Ñ x86_64
          echo "CC_x86_64=${NDK_TOOLCHAIN}/bin/x86_64-linux-android${ANDROID_API}-clang" >> $GITHUB_ENV
          echo "CXX_x86_64=${NDK_TOOLCHAIN}/bin/x86_64-linux-android${ANDROID_API}-clang++" >> $GITHUB_ENV
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²
          echo "â”€â”€â”€â”€ Compiler verification â”€â”€â”€â”€"
          "${NDK_TOOLCHAIN}/bin/aarch64-linux-android${ANDROID_API}-clang" --version || true
          "${NDK_TOOLCHAIN}/bin/armv7a-linux-androideabi${ANDROID_API}-clang" --version || true

      # â”€â”€ 8. Go dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download Go dependencies
        run: |
          go mod download
          go mod verify

      # â”€â”€ 9. Setup Node.js & Build Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          echo "â”€â”€â”€â”€ Frontend dist â”€â”€â”€â”€"
          ls -la dist/

      - name: Copy frontend to mobile package
        run: |
          rm -rf mobile/dist
          cp -r frontend/dist mobile/dist
          ls -la mobile/dist

      # â”€â”€ 10. BUILD: gomobile bind â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # gomobile bind ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ Go Ğ¿Ğ°ĞºĞµÑ‚ Ğ² .aar Ğ´Ğ»Ñ Android.
      # CGO_ENABLED=1 Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½ Ğ´Ğ»Ñ I2P Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸.
      # gomobile Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ NDK clang Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹.
      #
      - name: Build AAR with CGO
        run: |
          export PATH="$PATH:$(go env GOPATH)/bin"
          export CGO_ENABLED=1
          export ANDROID_NDK_HOME="${{ env.ANDROID_NDK_HOME }}"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Building teleghost.aar"
          echo "  CGO_ENABLED=$CGO_ENABLED"
          echo "  ANDROID_NDK_HOME=$ANDROID_NDK_HOME"
          echo "  Target: android (API ${{ env.ANDROID_API }})"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° .aar
          # -v Ğ´Ğ»Ñ verbose Ğ»Ğ¾Ğ³Ğ¾Ğ²
          # -target=android Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ arm, arm64, x86_64
          # -androidapi Ğ·Ğ°Ğ´Ğ°Ñ‘Ñ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ API level
          CGO_ENABLED=1 gomobile bind \
            -v \
            -tags cgo_i2pd \
            -target=android \
            -androidapi ${{ env.ANDROID_API }} \
            -o teleghost.aar \
            ./mobile
          
          echo "â”€â”€â”€â”€ Build output â”€â”€â”€â”€"
          ls -lh teleghost.aar
          file teleghost.aar

      # â”€â”€ 10. Upload AAR artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleghost-aar
          path: teleghost.aar
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Android APK (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Gradle Ğ¿Ñ€Ğ¾ĞµĞºÑ‚)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-apk:
    name: Build Android APK
    needs: build-aar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ .aar Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ job-Ğ°
      - name: Download AAR artifact
        uses: actions/download-artifact@v4
        with:
          name: teleghost-aar
          path: android/app/libs/

      - name: Verify AAR
        run: |
          echo "â”€â”€â”€â”€ Verifying AAR â”€â”€â”€â”€"
          ls -lh android/app/libs/
          file android/app/libs/teleghost.aar

      # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ (Svelte â†’ dist)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          echo "â”€â”€â”€â”€ Frontend dist â”€â”€â”€â”€"
          ls -la dist/

      # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ dist Ğ² assets Android Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
      # (Ñ…Ğ¾Ñ‚Ñ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Go Ñ€Ğ°Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ ÑĞ°Ğ¼, Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²)
      - name: Copy frontend to Android assets
        run: |
          mkdir -p android/app/src/main/assets
          cp -r frontend/dist/* android/app/src/main/assets/
          echo "â”€â”€â”€â”€ Android assets â”€â”€â”€â”€"
          ls -la android/app/src/main/assets/

      # Gradle build
      - name: Build APK
        run: |
          cd android
          chmod +x gradlew 2>/dev/null || true
          ./gradlew assembleDebug --stacktrace || {
            echo "â”€â”€â”€â”€ Gradle wrapper not found, using system gradle â”€â”€â”€â”€"
            gradle assembleDebug --stacktrace
          }

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleghost-android-debug
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Release (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ push Ñ‚ĞµĞ³Ğ° v*)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release-android:
    name: Release Android
    needs: [build-aar, build-apk]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download AAR
        uses: actions/download-artifact@v4
        with:
          name: teleghost-aar

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: teleghost-android-debug

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            teleghost.aar
            *.apk
          draft: false
          prerelease: true
          body: |
            ## Android Build ğŸ¤–
            
            ### ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹:
            - `teleghost.aar` â€” Go Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° Ğ´Ğ»Ñ Android (gomobile bind + CGO)
            - `*.apk` â€” Debug APK Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            
            ### Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
            - Android 5.0+ (API 21)
            - ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹: arm64-v8a, armeabi-v7a, x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
